/**
 *  Copyright (C) 2015  Albert Zedlitz
 *  
 *  This program is free software: you can redistribute it and/or modify
 *  it under the terms of the GNU General Public License as published by
 *  the Free Software Foundation, either version 3 of the License, or
 *  (at your option) any later version.
 *  
 *  This program is distributed in the hope that it will be useful,
 *  but WITHOUT ANY WARRANTY; without even the implied warranty of
 *  MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
 *  GNU General Public License for more details.
 *  
 *  You should have received a copy of the GNU General Public License
 *  along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/

/* Variable declaration generated by agent:
 */
// var g_eezz_socket_addr = "ws://{host}:{port}";
// var g_eezz_arguments   = "{args}";
var g_eezz_web_socket;
window.onload = eezz_connect();

// Open and controlling the WEB socket
function eezz_connect() {
    console.log('connect websocket ...');
	g_eezz_web_socket        = new WebSocket(g_eezz_socket_addr);
    g_eezz_web_socket.onopen = function() {
        console.log('on open websocket...');
        var x_title   = "document";
        var x_title_tags = document.getElementsByTagName('title');
        if (x_title_tags.length > 0) {
            x_title   = x_title_tags[0].innerHTML;
        }
        var x_body    = document.body;
        var x_json    = {"initialize": x_body.innerHTML, "args": g_eezz_arguments, 'title': x_title};
        g_eezz_web_socket.send(JSON.stringify(x_json));
    }
    
    /* Error handling: Reopen connection */
    g_eezz_web_socket.onerror = function(a_error) {
        console.log('error on websocket ...');
        window.console.error(a_error);
    }

    /* Wait for the application and update the document          */
    g_eezz_web_socket.onmessage = function(a_event) {
        var x_json = JSON.parse(a_event.data)
        if (x_json.update) {
           console.log('update  ');
            var x_array_descr = x_json.update;
            for (var i = 0; i < x_array_descr.length; i++) {
                var x_descr = x_array_descr[i];
                var x_elem  = document.getElementById(x_descr.id);
                dynamic_update(x_elem, x_descr.html, x_descr.attrs);

                try { // call a user defined function to enable formatting for example datetime: query [timestamp]
                   if (typeof eezz_format_update === 'function') {
                        eezz_format_update(x_elem);
                    };
                } catch(err) {
                    console.log("error " + err);
                }}}}
}

// Dynamic update: The inner-HTML of the element is calculated by the server
// The result is send via WEB socket as json = {tag-name: html, ...}
function dynamic_update(a_element, a_json, a_attrs) {
    for (var x in a_json) {
        if (x == '.') {
            a_element.innerHTML = a_json[x];
        }
        else {
            var x_list  = a_element.getElementsByTagName(x);
            x_list[0].innerHTML =  a_json[x];
        }
    }
}

// Function collects all eezz events from page using WEB-socket to
// send a request to the server
function eezy_click(aEvent, aElement) {
    var x_post     = true;
    var x_response = "";
    var x_json     = JSON.parse(aElement.getAttribute('data-eezz-json'));

    if (!x_post) {
        return;
    }
    // Generated elements: Return without modifications
    if (aElement.hasAttribute('data-eezz-template')) {
        x_response = JSON.stringify({'event': x_json});
        g_eezz_web_socket.send(x_response);
        return;
    }

    // User form elements: Collect the input data of this page.
    // The syntax for collection is as follows
    // function( key = "id-of-element"."attribute-of-element", ... )
    var x_args = x_json.args
    for (x_key in x_args) {
        var x_split   = x_args.x_key.split('.');
        if (x_split.length != 2) {
            continue;
        }
        var x_element = document.getElementById(x_split[0]);
        if (x_element == null) {
            continue;
        }
        x_args.x_key  = x_element.getAttribute(x_split[1]);
    }
    x_response = JSON.stringify({'event': x_json});
    g_eezz_web_socket.send(x_response);
}
